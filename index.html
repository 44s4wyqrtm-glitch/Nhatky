<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trader Journal V8.9 - Analytics Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #161b22; border: 1px solid #30363d; border-radius: 12px; overflow: hidden; }
        .input-dark { background-color: #0d1117; border: 1px solid #30363d; color: white; width: 100%; padding: 12px; border-radius: 8px; font-size: 13px; }
        .tab-active { border-bottom: 2px solid #58a6ff; color: #58a6ff; font-weight: bold; }
        .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #30363d; font-size: 12px; }
        .img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 8px; border: 1px dashed #30363d; }
    </style>
</head>
<body class="p-4 pb-24">
    <div class="max-w-md mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-black text-white italic tracking-tighter uppercase">V8.9 Master</h1>
            <div id="balanceTotal" class="text-xl font-bold text-green-500">$0.0</div>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-6">
            <button onclick="askAI()" class="bg-indigo-600/20 border border-indigo-500 text-indigo-400 py-2 rounded-lg text-[10px] font-bold uppercase">üß† AI Advisor</button>
            <div class="bg-gray-800/30 border border-gray-700 py-2 rounded-lg text-center text-[10px] font-bold uppercase">Win: <span id="winRate" class="text-purple-400">0%</span></div>
        </div>

        <div class="card p-4 mb-6 border-t-4 border-t-blue-500 shadow-xl">
            <form id="openTradeForm" class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="pair" placeholder="C·∫∂P TI·ªÄN" class="input-dark uppercase font-bold" required>
                    <input type="number" step="any" id="entry" placeholder="ENTRY" class="input-dark" oninput="calculateRR()">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" step="any" id="sl" placeholder="STOP LOSS" class="input-dark text-red-400" oninput="calculateRR()">
                    <input type="number" step="any" id="tp" placeholder="TAKE PROFIT" class="input-dark text-green-400" oninput="calculateRR()">
                </div>
                <div class="flex justify-center"><span id="rrDisplay" class="text-[10px] font-bold text-gray-500">R:R Ratio: --</span></div>
                <div>
                    <input type="file" id="chartImg" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <button type="button" onclick="document.getElementById('chartImg').click()" class="w-full py-2 border border-dashed border-gray-600 rounded-lg text-[10px] text-gray-400 font-bold">üì∑ CH√àN ·∫¢NH CHART</button>
                    <img id="imgPre" class="img-preview hidden">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:scale-95 transition uppercase text-xs">K√≠ch Ho·∫°t L·ªánh</button>
            </form>
        </div>

        <div class="flex gap-4 border-b border-gray-800 mb-4 text-[10px] font-bold uppercase">
            <button onclick="switchTab('running')" id="tabR" class="pb-2 tab-active">ƒêang ch·∫°y</button>
            <button onclick="switchTab('history')" id="tabH" class="pb-2 text-gray-500">Nh·∫≠t k√Ω</button>
            <button onclick="switchTab('stats')" id="tabS" class="pb-2 text-gray-500">Th·ªëng k√™</button>
        </div>

        <div id="runningView" class="space-y-3"></div>
        <div id="historyView" class="hidden space-y-3"></div>
        <div id="statsView" class="hidden space-y-4">
            <div class="card p-4">
                <h3 class="text-xs font-bold text-blue-400 mb-2 uppercase">üìÖ Th·ªëng k√™ th·ªùi gian</h3>
                <div class="stat-row"><span>H√¥m nay:</span> <b id="statDay">$0.0</b></div>
                <div class="stat-row"><span>Tu·∫ßn n√†y:</span> <b id="statWeek">$0.0</b></div>
                <div class="stat-row"><span>Th√°ng n√†y:</span> <b id="statMonth">$0.0</b></div>
            </div>
            <div class="card p-4">
                <h3 class="text-xs font-bold text-yellow-500 mb-2 uppercase">üìä C·∫∑p Ti·ªÅn & Gi·ªù V√†ng</h3>
                <div id="pairStats" class="divide-y divide-gray-800 mb-2"></div>
                <div id="timeStats" class="divide-y divide-gray-800"></div>
            </div>
        </div>
    </div>

    <script>
        let trades = JSON.parse(localStorage.getItem('trade_v89')) || [];
        let currentImgBase64 = "";

        function calculateRR() {
            const e = parseFloat(document.getElementById('entry').value);
            const sl = parseFloat(document.getElementById('sl').value);
            const tp = parseFloat(document.getElementById('tp').value);
            const rrBox = document.getElementById('rrDisplay');
            if (e && sl && tp && e !== sl) {
                const rr = (Math.abs(tp - e) / Math.abs(e - sl)).toFixed(2);
                rrBox.innerText = `R:R Ratio: 1 : ${rr}`;
                rrBox.className = rr >= 2 ? "text-[10px] font-bold text-green-500" : "text-[10px] font-bold text-yellow-500";
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { currentImgBase64 = e.target.result; document.getElementById('imgPre').src = currentImgBase64; document.getElementById('imgPre').classList.remove('hidden'); }
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('openTradeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const now = new Date();
            trades.push({
                id: Date.now(),
                pair: document.getElementById('pair').value.toUpperCase(),
                entry: document.getElementById('entry').value, sl: document.getElementById('sl').value, tp: document.getElementById('tp').value,
                img: currentImgBase64, status: 'running', pnl: 0,
                hour: now.getHours(), timestamp: now.getTime(),
                dateStr: now.toISOString().split('T')[0], // YYYY-MM-DD
                displayDate: now.toLocaleString('vi-VN', {hour12:false})
            });
            currentImgBase64 = ""; document.getElementById('imgPre').classList.add('hidden');
            this.reset(); save();
        });

        function closeTrade(id) {
            const p = prompt("Ch·ªët bao nhi√™u ƒë√¥ m?", "0");
            if (p === null) return;
            const idx = trades.findIndex(t => t.id === id);
            trades[idx].pnl = parseFloat(p);
            trades[idx].status = 'closed';
            save();
        }

        function save() { localStorage.setItem('trade_v89', JSON.stringify(trades)); render(); }

        function getWeek(d) {
            const date = new Date(d);
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function render() {
            const histDiv = document.getElementById('historyView');
            const runDiv = document.getElementById('runningView');
            const pBox = document.getElementById('pairStats');
            const tBox = document.getElementById('timeStats');
            histDiv.innerHTML = ''; runDiv.innerHTML = ''; pBox.innerHTML = ''; tBox.innerHTML = '';
            
            let total = 0, winCount = 0, closedCount = 0;
            let dPnL = 0, wPnL = 0, mPnL = 0;
            let pairs = {}, times = {"S√°ng": 0, "Chi·ªÅu": 0, "T·ªëi": 0};

            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const currentWeek = getWeek(now);
            const currentMonth = now.getMonth();

            trades.forEach(t => {
                const imgHTML = t.img ? `<img src="${t.img}" class="w-full h-32 object-cover rounded-md my-2" onclick="window.open('${t.img}')">` : '';
                if(t.status === 'running') {
                    runDiv.insertAdjacentHTML('beforeend', `<div class="card p-3 border-l-4 border-l-yellow-500"><div class="flex justify-between items-center font-bold"><span>${t.pair}</span><button onclick="closeTrade(${t.id})" class="text-[10px] bg-blue-600 px-3 py-1 rounded-full">CH·ªêT</button></div><p class="text-[10px] text-gray-500 font-mono">E: ${t.entry} | SL: ${t.sl}</p>${imgHTML}</div>`);
                } else {
                    total += t.pnl; closedCount++;
                    if(t.pnl > 0) winCount++;
                    
                    // Th·ªëng k√™ th·ªùi gian
                    const tDate = new Date(t.timestamp);
                    if(t.dateStr === todayStr) dPnL += t.pnl;
                    if(getWeek(tDate) === currentWeek && tDate.getFullYear() === now.getFullYear()) wPnL += t.pnl;
                    if(tDate.getMonth() === currentMonth && tDate.getFullYear() === now.getFullYear()) mPnL += t.pnl;

                    pairs[t.pair] = (pairs[t.pair] || 0) + t.pnl;
                    if(t.hour >= 4 && t.hour <= 11) times["S√°ng"] += t.pnl;
                    else if(t.hour >= 12 && t.hour <= 17) times["Chi·ªÅu"] += t.pnl;
                    else times["T·ªëi"] += t.pnl;

                    histDiv.insertAdjacentHTML('afterbegin', `<div class="card p-3 border-l-4 ${t.pnl>=0?'border-l-green-500':'border-l-red-500'} mb-2"><div class="flex justify-between font-bold"><span>${t.pair}</span><span class="${t.pnl>=0?'text-green-500':'text-red-500'}">${t.pnl}$</span></div>${imgHTML}<p class="text-[9px] text-gray-700 mt-1">${t.displayDate}</p></div>`);
                }
            });

            document.getElementById('statDay').innerText = `${dPnL.toFixed(1)}$`;
            document.getElementById('statWeek').innerText = `${wPnL.toFixed(1)}$`;
            document.getElementById('statMonth').innerText = `${mPnL.toFixed(1)}$`;
            document.getElementById('balanceTotal').innerText = `$${total.toFixed(1)}`;
            document.getElementById('winRate').innerText = closedCount > 0 ? Math.round((winCount/closedCount)*100) + '%' : '0%';
            
            Object.keys(pairs).forEach(k => pBox.insertAdjacentHTML('beforeend', `<div class="stat-row"><span>${k}</span><b class="${pairs[k]>=0?'text-green-500':'text-red-500'}">${pairs[k].toFixed(1)}$</b></div>`));
            Object.keys(times).forEach(k => tBox.insertAdjacentHTML('beforeend', `<div class="stat-row"><span>Ca ${k}</span><b>${times[k].toFixed(1)}$</b></div>`));
        }

        function switchTab(t) {
            document.getElementById('runningView').classList.toggle('hidden', t !== 'running');
            document.getElementById('historyView').classList.toggle('hidden', t !== 'history');
            document.getElementById('statsView').classList.toggle('hidden', t !== 'stats');
            document.getElementById('tabR').className = t === 'running' ? 'pb-2 tab-active' : 'pb-2 text-gray-500';
            document.getElementById('tabH').className = t === 'history' ? 'pb-2 tab-active' : 'pb-2 text-gray-500';
            document.getElementById('tabS').className = t === 'stats' ? 'pb-2 tab-active' : 'pb-2 text-gray-500';
        }
        render();
    </script>
</body>
</html>
